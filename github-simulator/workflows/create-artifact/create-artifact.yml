name: Create Artifact Workflow

on:
  repository_dispatch:
    types: [create-artifact-command]
  workflow_dispatch:
    inputs:
      artifact_name:
        description: 'Artifact name'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
        - dev1
        - sit1
        - uat1
        - prod1

jobs:
  validate-artifact:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        repository: 'britishairways-nexus/nx-artifacts-inventory'
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Validate artifact structure
      run: |
        echo "ðŸ” Validating artifact structure for ${{ github.event.client_payload.artifact_name }}"
        
        # Check if artifact follows naming convention
        if [[ "${{ github.event.client_payload.artifact_name }}" =~ ^nx-(al|bal|bb|bc|bff|tc|xp)-(.+)$ ]]; then
          echo "âœ… Artifact naming convention valid"
        else
          echo "âŒ Invalid artifact naming convention"
          exit 1
        fi
        
    - name: Create inventory entry
      run: |
        ARTIFACT_NAME="${{ github.event.client_payload.artifact_name }}"
        ENVIRONMENT="${{ github.event.client_payload.environment }}"
        
        # Create inventory file structure
        mkdir -p "nx-artifacts/$(echo $ARTIFACT_NAME | cut -d'-' -f2)/$ARTIFACT_NAME"
        
        # Generate inventory YAML
        cat > "nx-artifacts/$(echo $ARTIFACT_NAME | cut -d'-' -f2)/$ARTIFACT_NAME/nx-$ENVIRONMENT-inventory.yaml" << INVENTORY_EOF
schema_version: "1.0"

artifact_metadata:
  artifact_name: "$ARTIFACT_NAME"
  layer: "$(echo $ARTIFACT_NAME | cut -d'-' -f2)"
  domain: "web"
  service: "$(echo $ARTIFACT_NAME | cut -d'-' -f3)"
  description: "Newly created artifact"
  owner: "${{ github.actor }}"

infrastructure:
  enabled: false
  deployed: false
  component: "service_account"
  environment: "$ENVIRONMENT"

components:
  service_account:
    name: "sa-$ARTIFACT_NAME"
    namespace: "nexus-$ENVIRONMENT"
    enabled: false
    
  redis:
    name: ""
    cluster_id: ""
    endpoint: ""
    enabled: false
    
  ecr:
    repository_name: "$ARTIFACT_NAME"
    image_tag: "latest"
    enabled: false
INVENTORY_EOF
        
        echo "ðŸ“ Inventory file created successfully"
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "feat: Create artifact inventory for ${{ github.event.client_payload.artifact_name }}" || echo "No changes to commit"
        git push
        
    - name: Create approval comment
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## âœ… Artifact Created Successfully
            
            **Artifact Name**: ${{ github.event.client_payload.artifact_name }}
            **Environment**: ${{ github.event.client_payload.environment }}
            **Layer**: $(echo ${{ github.event.client_payload.artifact_name }} | cut -d'-' -f2)
            
            The artifact has been registered in the inventory and is ready for infrastructure approval.
            
            Next steps:
            1. Run \`/approve-infra-creation --env=${{ github.event.client_payload.environment }}\` to deploy infrastructure
            2. Or run \`/add-redis --env=${{ github.event.client_payload.environment }}\` to add Redis cache
            
            ---
            *Workflow completed at: ${new Date().toISOString()}*`
          })
